---
index: 5
icon: creative
title: ARP프로토콜
category:
  - Network
tag:
  - 네트워크
editLink: false
---

:::tip GOAL
Q. ARP가 하는 일?  
Q. ARP 프로토콜의 구조?  
Q. IP주소로 MAC주소를 알아오는 과정?  
:::

## ARP 프로토콜이 하는 일

  ARP 프로토콜은 같은 네트워크 대역에서 통신을 하기 위해 필요한 ==MAC주소를 IP주소를 이용해서 알아오는 프로토콜이다.==
  같은 네트워크 대역에서 통신을 한다고 하더라고 데이터를 보내기 위해서는 7계층부터 캡슐화를 통해 데이터를 보내기 때문에 IP주소와 MAC주소가 모두 필요하다.
  이 때 IP주소는 알고 MAC 주소는 모르더라도 ARP를 통해 통신이 가능하다.

## ARP 프로토콜 구조

![ARP](./img/ARP.png)

**28Byte**

- Hardware Type(2Byte) : 2계층에서 사용하는 프로토콜의 타입 주로 0001(Ethernet) 
- Protocal Type(2Byte) : 여기서 쓰이는 Protocol Address의 타입, 주로 0800(IPv4) 
- Hardware Address Length(1Byte) : MAC주소의 길이 6Byte => 06 
- Protocal Address Length(1Byte) : IPv4주소 길이 4Byte => 04 
- Opcode(2Byte) : operation code, 해당 프로토콜이 어떻게 동작하는지 나타낸다.  ARP프로토콜로 MAC주소를 물어보면 요청
  0001-요청 /0002-응답 
- Source Hardware Address(6Byte) : 출발지의 MAC 주소 
- Source Protocol Address(4Byte) : 출발지의 IP 주소
- Destination Hardware Address(6Byte) : 목적지의 MAC 주소 
- Destination Protocol Address(4Byte) : 목적지의 IP 주소 

## ARP 프로토콜의 통신 과정

 IP주소만 알고 있을 때 어떤과정으로 ARP프로토콜로 MAC주소를 알아올수 있을까?  
  ![arp-통신과정](./img/5-arp-통신과정.png)

*  하나의 네트워크 대역(같은 LAN대역)에서 ARP 프로토콜로 NAC주소 알아오는 과정  
   1) A가 C 컴퓨터와 통신하려고 MAC주소 필요한데 IP 주소만 알고 있는 상황이다.
   2) 먼저 A 컴퓨터가 ARP요청 프로토콜을 만들어서 인캡슐레이션 해서 보낸다. 
      이때 상대방의 MAC주소를 모르기 때문에 0을 채워서 보낸다.
   3) 같은 네트워크 대역에 요청을 보내기 위해 2계층 프로토콜의 Ethernet프로토콜이 필요하다. 여기서는 목적지 MAC주소를 FFFFFF로 채워서 보낸다(1로 채움). 그러면 같은 네트워크대역안에 모든 컴퓨터로 브로드캐스트 요청을 한다.
   :::note 2계층 장비 스위치
    스위치는 대표적인 2계층 장비로 2계층까지만 디캡슐레이션해서 목적지로 요청을 전달 해준다. 
    여기서는 Ethernet프로토콜까지만 확인하고 ARP프로토콜은 확인하지 않는다. 
    Ethernet프로토콜로 목적지 MAC주소 확인했는데 브로드캐스트니까 모두에게 보내준다
   :::
   4) 해당 요청을 받은 모든 컴퓨터는 디캡슐레이션 한다. 2계층 까니까 나한테 보내진게 맞다(브로드 캐스트니까)
   그래서 3계층도 까본다. 그런데 본인의 IP주소와 프로토콜의 목적지 IP주소가 일치하지 않은 애들은 패킷을 버린다.
   C의 경우는 일치한다. 그렇기 때문에 ARP 응답프로토콜을 만든다.(응답코드 0002) 출발지 MAC주소에 자신의 MAC주소 적어서 준다. 목적지 MAC주소에는 나한테 요청 보낸 프로토콜로 알 수 있다.
   5) 이제 브로드캐스트 할 필요 없이 목적지 MAC주소 적어서 보내면 다시 스위치가 A에게 전달해준다.
   이제 A가 ARP응답을 보고 C의 MAC주소를 알아낸후 ARP 캐시테이블에 등록한다. 
   6) 추후 같은 ip로 통신 할 때는 위의 작업을 거칠 필요가 없이 ARP 캐시테이블에서 MAC주소를 받아 올 수 있다.
   (key : ip주소, value : mac주소)

위와 같은 과정으로 MAC주소를 알아오고 난 다음 통신이 시작된다. 최초 통신할 때 이 과정을 거쳤다가 통신이 시작되는 것이다.

## ARP 테이블

cmd 에서 `arp -a` 검색하면 arp 테이블 확인 할 수 있다.
![arp-a 확인](./img/5-arp-a.png)  
위처럼 나와 통신했던 주소들의 IP와 MAC주소를 매핑시킨 테이블이다.

ARP의 특징 중 하나는 3계층인데 같은 네트워크 대역에서만 쓰인다는 것이다.
그 이유는 ARP프로토콜이 MAC주소를 몰라서 이더넷 프로토콜로 브로드캐스트하기 때문에
공유기는 브로드캐스트가 오면 버린다. 외부로 통신하지 않는다. 그래서 같은 네트워크대역에서만 사용되는 것이다.

## 실습
**1. arp 프로토콜 확인하기**

![arp-실습](./img/5-arp-실습.png)
info 탭에 ?가 달려있는게 요청, 안 달려있는게 응답이다.

**요청 프로토콜**  
![arp-실습-요청프로토콜](./img/5-arp-실습-2.png)

arp 프로토콜이 있고 하위 프로토콜로 이더넷 프로토콜이 인캡슐레이션 되어있다.   
arp 프로토콜을 열어서 살펴보면 위에서 배운 프로토콜의 구조대로 값이 할당되어 있는 것을 볼수 있다. 프로토콜의 구성대로 프로토콜에 빨간색 선을 그어놨다. 여기서 주의 깊게 볼것은 초록색 선으로 박스를 친 00 00 00 00 00 00 부분인데 목적지 MAC주소를 모르니까 비워놨다. 또한 이더넷 프로토콜을 보면 ff ff ff ff ff ff 인데. 이부분은 목적지 MAC 주소를 모르니까 모두에게
브로드 캐스트 하겠다는 의미이다.   

참고: 여기서 뒷부분에 000.. padding이란 프레임의 최소크기가 60Byte로 지정되어 있는데 ARP 는28Byte 이더넷은 14Byte이라 총 42Byte라서 최소를 맞춰주기위해서 붙은 것(최대는 바뀔수 있지만 보통 1514Byte 이다.)

**응답 프로토콜**  
![arp-실습-응답프로토콜](./img/5-arp-실습-33.png)
목적지 MAC주소는 내 MAC주소
이더넷 살펴보면 주소 지정되어있다. 브로드캐스트 아니라 유니캐스트한 것이다.  
참고: 패딩 안붙은건 와이어샤크의 패킷 캡쳐시점의 문제일뿐이다.

## Reference
[따라하며 배우는 IT - 네트워크 기초(YouTube)](https://www.youtube.com/playlist?list=PL0d8NnikouEWcF1jJueLdjRIC4HsUlULi)
